```markdown
# 后台任务

后台任务是一种特殊类型的`EventHandler`，它可以与其他`EventHandler`函数并发运行。这使得长时间运行的任务可以在不阻塞UI交互性的情况下执行。

使用`@rx.background`装饰异步的`State`方法来定义后台任务。

每当后台任务需要与状态交互时，**它必须进入`async with self`上下文块**，该上下文块将刷新状态并获取独占锁，以防止其他任务或事件处理程序同时修改它。由于在任务运行时其他`EventHandler`函数可能会修改状态，因此在上下文块之外，后台任务访问的变量可能会是_过时_的。如果尝试在上下文块之外的后台任务中修改状态，将会引发`ImmutableStateError`异常。

在下面的示例中，`my_task`事件处理程序使用`@rx.background`装饰，并且在满足一定条件的情况下，每隔半秒增加`counter`变量。在任务运行时，用户界面仍然可交互，并且继续正常处理事件。

## 任务生命周期

当触发后台任务时，它会立即启动，并将任务的引用保存在`app.background_tasks`中。任务完成后，它将从集合中移除。

可以同时运行多个相同的后台任务实例，并且框架不会试图避免重复启动任务。

开发人员需要确保在不希望出现重复任务的情况下不会创建重复任务。在上面的示例中，使用`_n_tasks`后端变量来控制`my_task`是否进入增量循环或提前退出。

## 后台任务的限制

后台任务大多像普通的`EventHandler`方法一样工作，但也有一些例外：

- 后台任务必须是`async`函数。
- 后台任务不能在`async with self`上下文块之外修改状态。
- 后台任务可以在`async with self`上下文块之外读取状态，但该值可能是过时的。
- 后台任务不能直接从其他事件处理程序或后台任务中调用。而是使用`yield`或`return`触发后台任务。

## 低级API

`@rx.background`装饰器是对较低级`App.modify_state`异步上下文管理器的便捷包装。如果需要更多对任务生命周期的控制，任意异步任务都可以使用`async with app.modify_state(token) as state`上下文块安全地操作状态。在这种情况下，状态的`token`可以从`state.get_token()`中获取，并且标识一个状态的单个实例（例如，一个浏览器标签的状态）。

务必注意**永远不要直接在`modify_state`上下文管理器之外直接修改状态**。如果创建任务的代码传递了状态实例的直接引用，这可能会引入微妙的错误或根本不起作用（如果状态存储使用了redis）。

下面的示例创建了一个任意的`asyncio.Task`来获取数据，然后使用低级API安全地更新状态并将更改发送到前端。

```
```

